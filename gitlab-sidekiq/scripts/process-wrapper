#!/bin/bash

set -e

echo "Starting Sidekiq"
/srv/gitlab/bin/bundle exec sidekiq \
              -r /srv/gitlab \
              -e production \
              -c $SIDEKIQ_CONCURRENCY \
              -t $SIDEKIQ_TIMEOUT \
              -C /srv/gitlab/config/sidekiq_queues.yml &
SIDEKIQ_PID=$!

if command -v xtail >/dev/null; then
    xtail /var/log/gitlab &
else
    # touch logs that would be generated by Jobs
    touch /var/log/gitlab/repocheck.log
    tail -f /var/log/gitlab/* &
fi

wait ${SIDEKIQ_PID}
