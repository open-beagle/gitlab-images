#!/bin/bash

set -e

# touch logs that would be generated by Rails
touch /var/log/gitlab/production.log

# pre-create known-good tmpdir
export TMPDIR=/tmp/gitlab
mkdir -p -m 3770 $TMPDIR

# switch to runtime directory
cd /srv/gitlab

if [ "${GITLAB_WEBSERVER^^}" = "PUMA" ]; then
  echo "Starting Puma"
  /srv/gitlab/bin/bundle exec puma --environment production \
    --config /srv/gitlab/config/puma.rb /srv/gitlab/config.ru &
else
  echo "Starting Unicorn"
  /srv/gitlab/bin/bundle exec unicorn -E production \
    -c /srv/gitlab/config/unicorn.rb /srv/gitlab/config.ru &
fi

if command -v xtail >/dev/null; then
    xtail /var/log/gitlab
else
    tail -f /var/log/gitlab/*
fi

wait
